name: Deploy to AWS (Terraform)

on:
  push:
    branches: [ prod ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: 1.6.0
  BUCKET_NAME: earth-app-prod

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      lambda_url: ${{ steps.lambda.outputs.lambda_url }}
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Terraform Init
      run: terraform init -migrate-state
    
    - name: Import existing resources (if needed)
      continue-on-error: true
      run: |
        set +e  # ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰
        
        # S3 ë²„í‚· ë° ê´€ë ¨ ë¦¬ì†ŒìŠ¤ import
        echo "=== Importing S3 resources ==="
        if terraform state show aws_s3_bucket.app >/dev/null 2>&1; then
          echo "S3 bucket already in state"
        else
          echo "Importing S3 bucket..."
          terraform import aws_s3_bucket.app ${{ env.BUCKET_NAME }} && echo "âœ… S3 bucket imported" || echo "âŒ S3 bucket import failed"
        fi
        
        if terraform state show aws_s3_bucket_public_access_block.app >/dev/null 2>&1; then
          echo "S3 public access block already in state"
        else
          terraform import aws_s3_bucket_public_access_block.app ${{ env.BUCKET_NAME }} && echo "âœ… S3 public access block imported" || echo "âŒ S3 public access block import failed"
        fi
        
        if terraform state show aws_s3_bucket_policy.app >/dev/null 2>&1; then
          echo "S3 bucket policy already in state"
        else
          terraform import aws_s3_bucket_policy.app ${{ env.BUCKET_NAME }} && echo "âœ… S3 bucket policy imported" || echo "âŒ S3 bucket policy import failed"
        fi
        
        if terraform state show aws_s3_bucket_website_configuration.app >/dev/null 2>&1; then
          echo "S3 website config already in state"
        else
          terraform import aws_s3_bucket_website_configuration.app ${{ env.BUCKET_NAME }} && echo "âœ… S3 website config imported" || echo "âŒ S3 website config import failed"
        fi
        
        # CloudFront OAC import (ID í•„ìš”)
        echo "=== Importing CloudFront OAC ==="
        if terraform state show aws_cloudfront_origin_access_control.app >/dev/null 2>&1; then
          echo "CloudFront OAC already in state"
        else
          OAC_ID=$(aws cloudfront list-origin-access-controls --query 'OriginAccessControlList.Items[?Name==`earth-app-prod-oac`].Id' --output text 2>/dev/null | head -1)
          if [ ! -z "$OAC_ID" ] && [ "$OAC_ID" != "None" ] && [ "$OAC_ID" != "" ]; then
            echo "Found OAC ID: $OAC_ID"
            terraform import aws_cloudfront_origin_access_control.app $OAC_ID && echo "âœ… CloudFront OAC imported" || echo "âŒ CloudFront OAC import failed"
          else
            echo "CloudFront OAC not found, will be created"
          fi
        fi
        
        # IAM Role import
        echo "=== Importing IAM resources ==="
        if terraform state show aws_iam_role.lambda_role >/dev/null 2>&1; then
          echo "IAM role already in state"
        else
          terraform import aws_iam_role.lambda_role earth-app-prod-lambda-role && echo "âœ… IAM role imported" || echo "âŒ IAM role import failed"
        fi
        
        if terraform state show aws_iam_role_policy.lambda_ssm >/dev/null 2>&1; then
          echo "IAM role policy already in state"
        else
          terraform import aws_iam_role_policy.lambda_ssm earth-app-prod-lambda-role:earth-app-prod-lambda-ssm-policy && echo "âœ… IAM role policy imported" || echo "âŒ IAM role policy import failed"
        fi
        
        if terraform state show aws_iam_role_policy_attachment.lambda_basic >/dev/null 2>&1; then
          echo "IAM role policy attachment already in state"
        else
          terraform import aws_iam_role_policy_attachment.lambda_basic earth-app-prod-lambda-role/arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole && echo "âœ… IAM role policy attachment imported" || echo "âŒ IAM role policy attachment import failed"
        fi
        
        echo "=== Import completed, refreshing state ==="
        terraform refresh -no-color || true
        
        set -e  # ë‹¤ì‹œ ì—ëŸ¬ ì²´í¬ í™œì„±í™”
    
    - name: Package Lambda function
      run: |
        cd ../lambda/gemini-analysis
        npm install --production
        zip -r ../../terraform/lambda-function.zip . -x "*.git*" "*.md" "README*"
        cd ../../terraform
    
    - name: Terraform Plan
      run: terraform plan -refresh=false
      continue-on-error: true
    
    - name: Terraform Apply
      if: github.ref == 'refs/heads/prod' || github.event_name == 'workflow_dispatch'
      run: terraform apply -auto-approve
    
    - name: Get CloudFront Distribution ID
      id: cloudfront
      run: |
        DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "CloudFront Distribution ID: $DISTRIBUTION_ID"
    
    - name: Get S3 Bucket Name
      id: s3
      run: |
        BUCKET_NAME=$(terraform output -raw s3_bucket_name)
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "S3 Bucket Name: $BUCKET_NAME"
    
    - name: Get Lambda Function URL
      id: lambda
      run: |
        LAMBDA_URL=$(terraform output -raw lambda_function_url)
        echo "lambda_url=$LAMBDA_URL" >> $GITHUB_OUTPUT
        echo "Lambda Function URL: $LAMBDA_URL"

  build-and-deploy:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    outputs:
      website_url: ${{ steps.terraform-output.outputs.website_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      env:
        REACT_APP_LAMBDA_FUNCTION_URL: ${{ needs.deploy-infrastructure.outputs.lambda_url }}
      run: npm run build
      
    - name: Get Terraform outputs
      id: terraform-output
      working-directory: ./terraform
      run: |
        terraform init
        BUCKET_NAME=$(terraform output -raw s3_bucket_name)
        DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)
        WEBSITE_URL=$(terraform output -raw website_url)
        LAMBDA_URL=$(terraform output -raw lambda_function_url)
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
        echo "lambda_url=$LAMBDA_URL" >> $GITHUB_OUTPUT
    
    - name: Deploy to S3
      run: |
        # ì •ì  íŒŒì¼ ì—…ë¡œë“œ (ìºì‹± 1ë…„)
        aws s3 sync build/ s3://${{ steps.terraform-output.outputs.bucket_name }} \
          --delete \
          --cache-control "public, max-age=31536000, immutable" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "manifest.json"
        
        # HTML íŒŒì¼ ì—…ë¡œë“œ (ìºì‹± ì—†ìŒ)
        aws s3 sync build/ s3://${{ steps.terraform-output.outputs.bucket_name }} \
          --delete \
          --cache-control "public, max-age=0, must-revalidate" \
          --exclude "*" \
          --include "*.html"
        
        # service-workerì™€ manifestëŠ” ìºì‹± ì—†ìŒ
        if [ -f build/service-worker.js ]; then
          aws s3 cp build/service-worker.js s3://${{ steps.terraform-output.outputs.bucket_name }}/ \
            --cache-control "public, max-age=0, must-revalidate"
        fi
        if [ -f build/manifest.json ]; then
          aws s3 cp build/manifest.json s3://${{ steps.terraform-output.outputs.bucket_name }}/ \
            --cache-control "public, max-age=0, must-revalidate"
        fi
    
    - name: Invalidate CloudFront cache
      if: steps.terraform-output.outputs.distribution_id != ''
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ steps.terraform-output.outputs.distribution_id }} \
          --paths "/*"
    
    - name: Deployment summary
      run: |
        echo "âœ… Deployment completed!"
        echo "ğŸŒ Your app is available at:"
        echo "   ${{ steps.terraform-output.outputs.website_url }}"
