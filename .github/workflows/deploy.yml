name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build application
      run: npm run build
        
    - name: Create deployment package
      run: |
        tar -czf build.tar.gz build/
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "SSH key length: ${#ORACLE_SSH_KEY}"
        
        # SSH í‚¤ê°€ ë¹„ì–´ìžˆëŠ”ì§€ í™•ì¸
        if [ -z "${{ secrets.ORACLE_SSH_KEY }}" ]; then
          echo "ERROR: ORACLE_SSH_KEY is empty!"
          exit 1
        fi
        
        # SSH í‚¤ ë‚´ìš© í™•ì¸ (ì²˜ìŒê³¼ ë ë¶€ë¶„ë§Œ)
        echo "SSH key starts with: $(echo "${{ secrets.ORACLE_SSH_KEY }}" | head -c 50)"
        echo "SSH key ends with: $(echo "${{ secrets.ORACLE_SSH_KEY }}" | tail -c 50)"
        
        echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # SSH í‚¤ íŒŒì¼ ë‚´ìš© í™•ì¸
        echo "SSH key file content (first 100 chars):"
        head -c 100 ~/.ssh/id_rsa
        
        ls -la ~/.ssh/
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        echo "Running ssh-keyscan..."
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
        echo "SSH setup completed"
        
        echo "SSH setup completed - ready for deployment"
        
    - name: Copy files to server
      run: |
        scp -P ${{ secrets.ORACLE_PORT }} build.tar.gz ${{ secrets.ORACLE_USERNAME }}@${{ secrets.ORACLE_HOST }}:/tmp/
        scp -P ${{ secrets.ORACLE_PORT }} nginx.conf ${{ secrets.ORACLE_USERNAME }}@${{ secrets.ORACLE_HOST }}:/tmp/
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USERNAME }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        port: ${{ secrets.ORACLE_PORT }}
        timeout: 60s
        command_timeout: 10m
        script: |
          # React ì•± ë°°í¬
          echo "Deploying React app..."
          
          # ê° ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê·¸
          echo "Step 1: Creating app directory..."
          sudo mkdir -p /var/www/earth
          sudo chown -R opc:opc /var/www/earth
          echo "Directory created: $(ls -la /var/www/earth/)"
          
          # ì•± ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/earth
          echo "Current directory: $(pwd)"
          
          # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
          echo "Step 2: Backing up existing files..."
          sudo cp -r build build.backup.$(date +%Y%m%d_%H%M%S) || echo "No existing build to backup"
          
          # ìƒˆ ë¹Œë“œ íŒŒì¼ ì••ì¶• í•´ì œ
          echo "Step 3: Extracting new build files..."
          sudo rm -rf build
          sudo mkdir -p build
          echo "Build directory created: $(ls -la build/)"
          
          echo "Extracting build.tar.gz..."
          sudo tar -xzf /tmp/build.tar.gz -C /var/www/earth/
          echo "Extraction completed. Build contents: $(ls -la build/)"
          sudo rm /tmp/build.tar.gz
          
          # ê¶Œí•œ ì„¤ì •
          echo "Step 4: Setting permissions..."
          sudo chown -R opc:opc /var/www/earth/build
          sudo chmod -R 755 /var/www/earth/build
          echo "Permissions set: $(ls -la build/)"
          
          echo "ðŸŽ‰ React app deployed successfully!"
          echo "ðŸ“ Files are available at: /var/www/earth/build"
          echo "ðŸš€ Ready to configure nginx in next step"
          
    - name: Setup and configure nginx
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USERNAME }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        port: ${{ secrets.ORACLE_PORT }}
        timeout: 20s
        command_timeout: 1m
        script: |
          echo "ðŸš€ Setting up nginx web server..."
          echo "Step 1: Checking deployment directory..."
          ls -la /var/www/earth/
          
          echo "Step 2: Copying nginx configuration..."
          # nginx.conf íŒŒì¼ì„ /tmpì—ì„œ ë³µì‚¬
          if [ -f /tmp/nginx.conf ]; then
            sudo cp /tmp/nginx.conf /etc/nginx/sites-available/earth
            sudo rm /tmp/nginx.conf
          else
            # ê¸°ë³¸ nginx ì„¤ì • ìƒì„±
            sudo bash -c 'cat > /etc/nginx/sites-available/earth << EOF
          server {
              listen 80;
              server_name _;
              
              root /var/www/earth/build;
              index index.html;
              
              # gzip ì••ì¶• í™œì„±í™”
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
              
              # ë³´ì•ˆ í—¤ë”
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src '\''self'\'' http: https: data: blob: '\''unsafe-inline'\''" always;
              
              # ì •ì  íŒŒì¼ ìºì‹±
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # React Routerë¥¼ ìœ„í•œ ì„¤ì •
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # ì—ëŸ¬ íŽ˜ì´ì§€
              error_page 404 /index.html;
          }
          EOF'
          fi
          
          echo "Step 3: Enabling nginx site..."
          sudo ln -sf /etc/nginx/sites-available/earth /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          echo "Step 4: Testing nginx configuration..."
          sudo nginx -t
          
          echo "Step 5: Setting proper permissions..."
          sudo chown -R www-data:www-data /var/www/earth/build
          sudo chmod -R 755 /var/www/earth/build
          
          echo "Step 6: Reloading nginx..."
          sudo systemctl reload nginx
          
          echo "Step 7: Checking nginx status..."
          sudo systemctl status nginx --no-pager -l || true
          sudo ss -tlnp | grep :80 || echo "Port 80 not listening"
          
          if sudo systemctl is-active --quiet nginx; then
            echo "âœ… SUCCESS: Nginx is running!"
            echo "ðŸŒ React app accessible at: http://$(curl -s ifconfig.me)"
          else
            echo "âŒ FAILED: Nginx is not running"
            sudo journalctl -u nginx --no-pager -l | tail -20
          fi
