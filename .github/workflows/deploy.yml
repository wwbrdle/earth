name: Deploy to AWS (Terraform)

on:
  push:
    branches: [ prod ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: 1.6.0

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Terraform Init
      run: terraform init
    
    - name: Package Lambda function
      run: |
        cd ../lambda/gemini-analysis
        npm install --production
        zip -r ../../terraform/lambda-function.zip . -x "*.git*" "*.md" "README*"
        cd ../../terraform
    
    - name: Terraform Plan
      run: terraform plan
      continue-on-error: true
    
    - name: Terraform Apply
      if: github.ref == 'refs/heads/prod' || github.event_name == 'workflow_dispatch'
      run: terraform apply -auto-approve
    
    - name: Get CloudFront Distribution ID
      id: cloudfront
      run: |
        DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "CloudFront Distribution ID: $DISTRIBUTION_ID"
    
    - name: Get S3 Bucket Name
      id: s3
      run: |
        BUCKET_NAME=$(terraform output -raw s3_bucket_name)
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "S3 Bucket Name: $BUCKET_NAME"

  build-and-deploy:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    outputs:
      website_url: ${{ steps.terraform-output.outputs.website_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      env:
        REACT_APP_LAMBDA_FUNCTION_URL: ${{ steps.terraform-output.outputs.lambda_url }}
      run: npm run build
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Get Terraform outputs
      id: terraform-output
      working-directory: ./terraform
      run: |
        terraform init
        BUCKET_NAME=$(terraform output -raw s3_bucket_name)
        DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)
        WEBSITE_URL=$(terraform output -raw website_url)
        LAMBDA_URL=$(terraform output -raw lambda_function_url)
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
        echo "lambda_url=$LAMBDA_URL" >> $GITHUB_OUTPUT
    
    - name: Deploy to S3
      run: |
        # ì •ì  íŒŒì¼ ì—…ë¡œë“œ (ìºì‹± 1ë…„)
        aws s3 sync build/ s3://${{ steps.terraform-output.outputs.bucket_name }} \
          --delete \
          --cache-control "public, max-age=31536000, immutable" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "manifest.json"
        
        # HTML íŒŒì¼ ì—…ë¡œë“œ (ìºì‹± ì—†ìŒ)
        aws s3 sync build/ s3://${{ steps.terraform-output.outputs.bucket_name }} \
          --delete \
          --cache-control "public, max-age=0, must-revalidate" \
          --exclude "*" \
          --include "*.html"
        
        # service-workerì™€ manifestëŠ” ìºì‹± ì—†ìŒ
        if [ -f build/service-worker.js ]; then
          aws s3 cp build/service-worker.js s3://${{ steps.terraform-output.outputs.bucket_name }}/ \
            --cache-control "public, max-age=0, must-revalidate"
        fi
        if [ -f build/manifest.json ]; then
          aws s3 cp build/manifest.json s3://${{ steps.terraform-output.outputs.bucket_name }}/ \
            --cache-control "public, max-age=0, must-revalidate"
        fi
    
    - name: Invalidate CloudFront cache
      if: steps.terraform-output.outputs.distribution_id != ''
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ steps.terraform-output.outputs.distribution_id }} \
          --paths "/*"
    
    - name: Deployment summary
      run: |
        echo "âœ… Deployment completed!"
        echo "ğŸŒ Your app is available at:"
        echo "   ${{ steps.terraform-output.outputs.website_url }}"
